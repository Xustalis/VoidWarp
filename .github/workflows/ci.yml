name: VoidWarp CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: "0 3 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  core-library:
    name: Core Library (Rust)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: core
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt
        
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: core
      
    - name: Check Formatting
      run: cargo fmt -- --check
      
    - name: Run Clippy
      run: cargo clippy -- -D warnings
      
    - name: Run Tests
      run: cargo test
      
    - name: Build Relase
      run: cargo build --release

  windows-platform:
    name: Windows Client (WPF)
    needs: core-library
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Build Core DLL
      working-directory: core
      run: cargo build --release
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        
    - name: Build WPF App
      run: dotnet build platforms/windows/VoidWarp.Windows.csproj -c Release
      
  android-platform:
    name: Android Client
    needs: core-library
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android NDK
      run: |
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
        
    - name: Configure Android Linkers
      run: |
        echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang" >> $GITHUB_ENV
        echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi26-clang" >> $GITHUB_ENV
        echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android26-clang" >> $GITHUB_ENV
        
    - name: Install cargo-ndk
      run: cargo install cargo-ndk --locked
      
    - name: Build Rust Library for Android
      working-directory: core
      run: cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 -o ../platforms/android/app/src/main/jniLibs build --release
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
        
    - name: Build APK
      working-directory: platforms/android
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug
